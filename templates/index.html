<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SewerSense</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='chatbot.css') }}"> <!-- Link to the chatbot CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 57vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">SewerSense</div>
            <div class="navbar-right">
                <ul>
                    <li><a href="#about">About</a></li>
                    <li><a href="{{ url_for('complaints') }}">Complaints</a></li>
                    <li><a href="{{ url_for('actions') }}">Actions</a></li>
                    <li><a href="#login-signup">Login/Sign Up</a></li>
                    <li><a href="#profile" class="profile-link">ðŸ‘¤</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <section class="intro-section">
        <h1 class="main-heading">SewerSense</h1>
        <p class="sub-heading" style= "color: #fff">Proactive Flood Prevention</p>
    </section>

    <button class="get-weather-button" id="getWeather">Get Weather Info for Your Location</button>


    <section class="weather-report-section">
        <div class="weather-report-container">
            <div class="weather-info" id="weatherInfo" style="display:none;">
                
                <div class="weather-details">
                    <p>Temperature: <span id="temp"></span> Â°C</p>
                    <p>Description: <span id="description"></span></p>
                    <p>Humidity: <span id="humidity"></span> %</p>
                    <p>Wind Speed: <span id="windSpeed"></span> m/s</p>
                </div>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <section class="map-section">
        <div id="map" class="map-container"></div>
        <h2>Place Dynamic Marker on the Map to View Sewage Insights</h2>

    </section>

    <div class="divider"></div>

    <section id="section-3">
        <h2 style="color: #CFFF81; text-transform: uppercase; padding: 20px 5;">SEWAGE INSIGHTS</h2>
        <!-- Filter Button and Dropdown -->
    <div class="filter-container">
        <button class="filter-btn">Filter by</button>
        <select class="filter-dropdown">
            <option value="days">Days</option>
            <option value="months">Months</option>
            <option value="years">Years</option>
        </select>
    </div>


        <div class="chart-wrapper">
            <div class="chart-container">
                <img src="{{ url_for('get_population_image') }}" alt="Population Chart" class="chart-image">
                <p class="chart-label">Percentage Risk</p>
            </div>
            <div class="chart-container">
                <img src="{{ url_for('get_second_chart_image') }}" alt="Second Chart" class="chart-image">
                <p class="chart-label">Percentage Blockage</p>

            </div>
        </div>
    </section>
    

   
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('map').setView([40.709, -74.010], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const defaultMarker = L.marker([40.709, -74.010]).addTo(map);
            defaultMarker.bindPopup("<b>Fulton Street, NYC</b><br>Default Marker").openPopup();

            map.on('click', function (e) {
                const newMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
                newMarker.bindPopup(`<b>Marker Location</b><br>Latitude: ${e.latlng.lat.toFixed(4)}, Longitude: ${e.latlng.lng.toFixed(4)}`).openPopup();
            });

            // Fetch weather data
            document.getElementById('getWeather').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        fetch('/get_weather_by_coords', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ lat: lat, lon: lon }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('temp').textContent = data.temperature;
                            document.getElementById('description').textContent = data.description;
                            document.getElementById('humidity').textContent = data.humidity;
                            document.getElementById('windSpeed').textContent = data.wind_speed;
                            document.getElementById('weatherInfo').style.display = 'block';
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to retrieve weather data.');
                        });
                    });
                } else {
                    alert('Geolocation is not supported by this browser.');
                }
            });

            
    

            
            // Fetch population data and draw chart
            const chartCanvas = document.createElement('canvas');
            chartCanvas.id = 'populationChart';
            document.querySelector('.chart-container').appendChild(chartCanvas);
            
            fetch('/get_population_data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                    } else {
                        const labels = data.data.map(row => row['Year']);
                        const values = data.data.map(row => parseFloat(row['Population']));
                        new Chart(chartCanvas, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Population Over Time',
                                    data: values,
                                    backgroundColor: '#CFFF81',
                                    borderColor: '#081F34',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching population data:', error);
                });
        });
  
    </script>
<!-- Watson Assistant Embed Script -->
<script>
    window.watsonAssistantChatOptions = {
        integrationID: "fbce0b0d-b6f0-42f3-962e-c12f4d563c9e", // Your integration ID.
        region: "au-syd", // The region your Watson Assistant is hosted in.
        serviceInstanceID: "bd39455c-bdc3-439d-8aa4-e2d9c051793b", // Your service instance ID.
        onLoad: async (instance) => { await instance.render(); }
    };
    setTimeout(function(){
        const t=document.createElement('script');
        t.src="https://web-chat.global.assistant.watson.appdomain.cloud/versions/" + (window.watsonAssistantChatOptions.clientVersion || 'latest') + "/WatsonAssistantChatEntry.js";
        document.head.appendChild(t);
    });
</script>

</body>
</html>
